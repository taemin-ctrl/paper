Keystone: An Open Framework for Architecting Trusted Execution Environments
====

## 요약

 TEE은 다양한 장치에서 사용이 증가하고 있지만, 현재의 TEE는 고정된 trade-off를 제공해 사용자 맞춤화가 어렵습니다.

 **Keystone**은 최초의 opensource 맞춤형 TEE framework로, RISC-V 하드웨어에서 메모리 격리와 프로그래밍 가능한 소프트웨어 계층을 활용하여 유연한 기능 선택과 플랫폼 별 수정을 지원합니다. Keystone은 작은 TCB, 강력한 보안, 다양한 벤치마크와 애플리케이션 실행을 통해 설계의 강점을 입증합니다<br/>
 
> **TEE(Trusted Execution Environments)** : 보안성을 높이기 위해 메인 proccess 내 별도로 독립된 보안 영역이 제공하는 안전한 실행 환경<br/>
> **TCB (Trusted Computing Base)** : 시스템의 보안을 유지하기 위해 반드시 신뢰할 수 있어야 하는 최소한의 하드웨어, 소프트웨어 구성 요소 집합.

-------

## 1.  다양한 TEE를 위한 공통 기반  
### 1.1 배경: 상용 TEE
#### 상용 TEE(신뢰 실행 환경) 비교표

|TEE 시스템	|주요 특징	|장점|	단점|
|--|--|--|--|
|Intel SGX	|사용자 공간 Enclave 지원	|세분화된 격리, 강력한 하드웨어 기반 보안	|큰 소프트웨어 스택 요구, 부채널 공격 취약|
|AMD SEV	|전체 VM 격리	|VM 단위 격리로 강력한 보안	|큰 TCB 요구, 추가적인 부채널 공격 방어 필요|
|ARM TrustZone	|Secure World 제공|	유연성 높음, 경량	|단일 격리 도메인만 지원, 추가 격리 시 소프트웨어 기반 솔루션 필요|
|Sanctum (RISC-V)|	사용자 공간 인클레이브 지원	|낮은 TCB, 하드웨어 변경 가능	|RISC-V 기반, 기존 하드웨어와 호환성 부족|
|Komodo	|TrustZone 기반 검증된 모니터|	검증된 신뢰 소프트웨어 제공	|TrustZone의 두 개 도메인 제한 유지|
<br/>

> **Enclave** : 보안이 필요한 코드와 데이터를 보호하기 위해 격리된 메모리 공간.<br/>
> **VM** : 하드웨어를 소프트웨어로 가상화한 환경으로, 하나의 물리적 시스템에서 여러 개의 운영 체제를 독립적으로 실행할 수 있게 함.<br/>
> **TrustZone** : ARM 프로세서에 내장된 하드웨어 기반 보안 기술로, 일반 영역(Non-secure World)과 보안 영역(Secure World)으로 CPU 상태를 분리하여 민감한 데이터와 코드 보호

---------

### 1.2 맞춤형 TEE(keystone)

#### 맞춤형 TEE
- 다양한 이해관계자가 자신의 요구에 맞는 TEE를 조립할 수 있음.
- 하드웨어 제조업체는 복잡한 기능을 만들 필요 없음. 
- 플랫폼 제공자는 하드웨어와 신뢰 모델을 선택하고, 인클레이브 프로그래머는 필요한 기능을 구현.

#### 맞춤형 TEE 필요 이유

- 위협 모델(어떤 공격을 막아야 하는지)이 애플리케이션, 하드웨어, 사용 사례에 따라 다름.
- Keystone은 앱마다 보안 기능을 다르게 설정할 수 있게 함.

#### 하드웨어 보안 플랫폼 요구사항

- CPU나 메모리 컨트롤러를 바꿀 필요 없음!
- 신뢰할 수 있는 부팅(부팅 과정이 변조되지 않도록 보장)
- 장치 고유 비밀 키(하드웨어마다 고유한 암호 키)
- 하드웨어 기반 난수 생성기(암호화할 때 사용하는 무작위 숫자 생성기)

--------------------------------------------------------


### 1.3 TEE 생명 주기의 주체들   

| 역할	| 설명	|
|--|--|
|하드웨어 제조업체	|RISC-V 칩을 설계하고 제작	|
|Keystone 플랫폼 제공자|	칩을 구매해 운영하며, 보안 모니터(SM) 설정	|
|Keystone 프로그래머	|Keystone의 소프트웨어(SM, RT, eapp)를 개발	|
|Keystone 사용자	|Keystone을 사용해 보안 환경을 구축	|
| Eapp 사용자	|보안 환경에서 실행되는 애플리케이션을 이용	|

> **eapp** : Enclave Application의 줄임 말이며 TEE안에서 실행되는 애플리케이션을 의미

------------------------------------------------------

## 2. Keystone 개요
### 2.1 설계 원칙

### 1. 프로그래밍 가능한 계층 및 신뢰할 수 없는 코드 아래의 격리 원칙 활용

- 보안 모니터(SM)를 통해 플랫폼의 TEE 보장

#### M-모드의 네 가지 특성 활용

1. 플랫폼 제공자가 프로그래밍 가능함
2. 최소한의 최고 권한 모드로 설계되어 요구 사항 충족
3. 시스템의 인터럽트 및 예외 처리를 하드웨어적으로 위임 가능
4. RISC-V의 물리 메모리 보호(PMP) 표준 제어를 통해 실행 시 메모리 맵 제어 기능을 격리

### 2. 리소스 관리와 보안 검사 분리
- SM은 보안 정책만 관리하고, 나머지 기능은 다른 소프트웨어가 처리함.(TCB 최소화)
- S-mode RT: 인클레이브의 메모리 관리, 시스템 호출 처리, 프로그램 수명 주기 관리.
- U-mode eapp: 실제 인클레이브에서 실행되는 애플리케이션(사용자 코드).
- RT와 eapp은 신뢰할 수 없는 OS나 다른 애플리케이션으로부터 격리됨.
- SBI(Supervisor Binary Interface): RT와 SM 간 통신을 가능하게 함
### 3. 모듈형 계층 설계
- Keystone은 **모듈형 구조(SM, RT, eapp)**로 설계되어 다양한 요구에 맞출 수 있음.
- 플랫폼 제공자나 프로그래머는 TEE 설계를 유연하게 수정할 수 있어, 레거시(기존) 시스템과도 쉽게 호환됨.
- 계층별 독립성: 각 계층이 독립적으로 동작하고, 상위 계층에 필요한 보안 기능을 제공.
- 권한 구조와 호환: 기존 하드웨어/OS 권한 관리와 자연스럽게 맞물림.

### 4. 세분화된 TCB 구성 허용
- 각 사용 사례에 맞는 최소 TCB를 설정해 맞춤형 TEE를 구성

> **pmp(Physical Memory Protection)** :  RISC-V 아키텍처에서 제공하는 물리 메모리 접근 제어 기법

--------------------------------

### 2.2 Keystone Enclave workflow

1. **플랫폼 제공자 준비**: 플랫폼 제공자는 적합한 하드웨어 사양 및 보안 확장을 설정하여 SM을 초기화

2. **인클레이브 개발자 준비**: 인클레이브 개발자는 Keystone 도구와 라이브러리를 사용하여 eapp과 RT를 작성

3. **eapp 개발**: 개발자는 eapp의 필요한 기능을 구현 및 실행 환경을 설정, 요구 사항을 기반으로 애플리케이션 최적화

4. **SM과 RT 상호작용**: RT는 SM의 SBI 호출을 통해 시스템의 기능을 사용할 수 있지만, RT는 SM이 제공하는 보안 격리 보장을 변경할 수 없음 

5. **eapp 배포**: eapp이 완성되면, 해당 인클레이브 애플리케이션을 배포하고 실행합니다.





































































































































